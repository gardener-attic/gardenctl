apiVersion: {{ include "deploymentversion" . }}
kind: Deployment
metadata:
  name: kibana-logging
  namespace: {{ .Release.Namespace }}
  labels:
    garden.sapcloud.io/role: logging
    app: kibana-logging
    role: logging
spec:
  selector:
    matchLabels:
      app: kibana-logging
      role: logging
  replicas: {{ .Values.kibana.replicaCount }}
  template:
    metadata:
      annotations:
        checksum/kibana-objects-registration-config: {{ include (print $.Template.BasePath "/kibana/kibana-objects-registration-config.yaml") . | sha256sum }}
        checksum/kibana-saved-objects-config: {{ include (print $.Template.BasePath "/kibana/kibana-saved-objects-config.yaml") . | sha256sum }}
      labels:
        garden.sapcloud.io/role: logging
        app: kibana-logging
        role: logging
    spec:
      containers:
      - name: kibana-logging
        image: {{ index .Values.global.images "kibana-oss" }}
        resources:
          # need more cpu upon initialization, therefore burstable class
          limits:
            cpu: 1000m
            memory: 300Mi
          requests:
            cpu: 100m
            memory: 200Mi
        env:
        - name: ELASTICSEARCH_URL
          value: http://elasticsearch-logging:{{ .Values.global.elasticsearchPorts.db }}
        ports:
        - containerPort: {{ .Values.kibana.service.internalPort }}
          name: ui
          protocol: TCP
{{- if .Values.kibana.readinessProbe.enabled }}
        readinessProbe:
          httpGet:
            path: /api/status
            port: {{ .Values.kibana.service.internalPort }}
          initialDelaySeconds: {{ .Values.kibana.readinessProbe.initialDelaySeconds }}
          timeoutSeconds: {{ .Values.kibana.readinessProbe.timeoutSeconds }}
          periodSeconds: {{ .Values.kibana.readinessProbe.periodSeconds }}
          successThreshold: {{ .Values.kibana.readinessProbe.successThreshold }}
          failureThreshold: {{ .Values.kibana.readinessProbe.failureThreshold }}
{{- end }}
      - image: {{ index .Values.global.images "kibana-oss" }}
        name: auto-create-objects
        command:
        - /bin/sh
        - /gardener/register/register
        volumeMounts:
        - name: register
          mountPath: /gardener/register
        - name: saved-objects
          mountPath: /gardener/saved-objects
        resources:
          limits:
            cpu: 10m
            memory: 20Mi
          requests:
            cpu: 10m
            memory: 20Mi
      volumes:
      - name: register
        configMap:
          name: kibana-object-registration
      - name: saved-objects
        configMap:
          name: kibana-saved-objects
